<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="weanlingNES">
<title>Detect phases of the day • weanlingNES</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Detect phases of the day">
<meta property="og:description" content="weanlingNES">
<meta property="og:image" content="jjoumaa.ddns.net/weanlingNES/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">weanlingNES</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Analyses</h6>
    <a class="dropdown-item" href="../articles/data_exploration_2016.html">Data Exploration - 2016</a>
    <a class="dropdown-item" href="../articles/data_exploration_2018.html">Data Exploration - 2018</a>
    <a class="dropdown-item" href="../articles/data_exploration_2018_map.html">Data Exploration Map - 2018</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Others</h6>
    <a class="dropdown-item" href="../articles/create_logo.html">Logo Design</a>
    <a class="dropdown-item" href="../articles/phase_of_the_day.html">Detect phases of the day</a>
    <a class="dropdown-item" href="../articles/netcdf_read.html">How to deal with netCDF files?</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Troubleshooting</h6>
    <a class="dropdown-item" href="../articles/session_info.html">R Session Info</a>
    <a class="dropdown-item" href="../articles/test.html">test</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Detect phases of the day</h1>
                        <h4 data-toc-skip class="author">Joffrey JOUMAA</h4>
            
            <h4 data-toc-skip class="date">January 13, 2022</h4>
      
      
      <div class="d-none name"><code>phase_of_the_day.Rmd</code></div>
    </div>

    
    
<p>We’ll like to find something similar to what was done for the individual <code>2004023</code>, that is to say find the different phase of the day: day and night, by identifying the sunrise and the sunset. For that we’ll try the function previously used in <code>2004023</code> and apply it to 2018 individuals. Then we’ll try other methods and decide which method fit the most our needs. Our ultimate goal is to be able to plot this kind of figure:</p>
<p><img src="../reference/figures/2004023_DaylengthWithSunriseSunset.png"></p>
<div class="section level2">
<h2 id="display-the-data-of-2018-individuals">Display the data of 2018-individuals<a class="anchor" aria-label="anchor" href="#display-the-data-of-2018-individuals"></a>
</h2>
<p>Let’s first load our package and our data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load library</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">weanlingNES</span><span class="op">)</span>

<span class="co"># load data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"data_nes"</span>, package <span class="op">=</span> <span class="st">"weanlingNES"</span><span class="op">)</span>

<span class="co"># combine all individuals</span>
<span class="va">data_2018</span> <span class="op">=</span> <span class="fu">rbindlist</span><span class="op">(</span><span class="va">data_nes</span><span class="op">$</span><span class="va">year_2018</span>, use.name <span class="op">=</span> <span class="cn">TRUE</span>, idcol <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co"># remove phase column for the purpose of this document</span>
<span class="va">data_2018</span><span class="op">[</span>, <span class="va">phase</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></code></pre></div>
<p>To visualize the data, we summarize each point on the plot as the median of the light level during one hour of one day.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># let's first average `lightatsurf` by individuals, day since departure and hour</span>
<span class="va">dataPlot</span> <span class="op">=</span> <span class="va">data_2018</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>lightatsurf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">lightatsurf</span><span class="op">)</span><span class="op">)</span>, 
                     by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">.id</span>,<span class="va">day_departure</span>,date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,<span class="va">hour</span><span class="op">)</span><span class="op">]</span>

<span class="co"># display the result</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dataPlot</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, fill <span class="op">=</span> <span class="va">lightatsurf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_tile</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">.id</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_jjo</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"# of days since departure"</span>, y <span class="op">=</span> <span class="st">"Hour"</span>, fill <span class="op">=</span> <span class="st">"Light level at the surface"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="phase_of_the_day_files/figure-html/phase-of-the-day-2-1.png" alt="Visualization of light level at the surface along 2018-individuals' trip" width="100%"><p class="caption">
Visualization of light level at the surface along 2018-individuals’ trip
</p>
</div>
<blockquote>
<p>Why is there so much data with missing value during day time?</p>
</blockquote>
<p>Well, the good news is that we can clearly see the same pattern we saw in <code>2004023</code>. Let’s look at the distribution</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># display the result</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dataPlot</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lightatsurf</span>, fill <span class="op">=</span> <span class="va">.id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">110</span>, linetype <span class="op">=</span> <span class="st">"longdash"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="va">.id</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_jjo</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="phase_of_the_day_files/figure-html/phase-of-the-day-3-1.png" alt="Distribution of `lightatsurf` with a threshold at 110." width="100%"><p class="caption">
Distribution of <code>lightatsurf</code> with a threshold at 110.
</p>
</div>
<p>There is a bimodal distribution for each individual that seems to be quite well separated by a threshold at <code>110</code>, which correspond to the threshold that has been used for the individual <code>2004023</code>. In 2018 individuals, 110 seems also to be an appropriate value.</p>
</div>
<div class="section level2">
<h2 id="lets-give-a-try-to-the-findtwilights-function">Let’s give a try to the <code>findTwilights</code> function<a class="anchor" aria-label="anchor" href="#lets-give-a-try-to-the-findtwilights-function"></a>
</h2>
<p>Let’s first reshape our data to complied with the <code>findTwilights</code> function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># identification of sunset, sunrise pairs</span>
<span class="va">res_twi</span> <span class="op">=</span> <span class="va">data_2018</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">lightatsurf</span><span class="op">)</span>,
                    <span class="fu">findTwilights</span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>Date <span class="op">=</span> <span class="va">date</span>, Light <span class="op">=</span> <span class="va">lightatsurf</span><span class="op">)</span>, 
                                  threshold <span class="op">=</span> <span class="fl">110</span>, include<span class="op">=</span><span class="va">date</span><span class="op">)</span>, by<span class="op">=</span><span class="va">.id</span><span class="op">]</span>

<span class="co"># add `day_departure` to res_twi using a rolling join </span>
<span class="co"># https://www.r-bloggers.com/2016/06/understanding-data-table-rolling-joins/</span>
<span class="va">res_twi</span> <span class="op">=</span> <span class="va">data_2018</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">.id</span>, Twilight <span class="op">=</span> <span class="va">date</span>, <span class="va">day_departure</span><span class="op">)</span>
                    <span class="op">]</span><span class="op">[</span><span class="va">res_twi</span>, roll<span class="op">=</span><span class="cn">T</span>, on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">".id"</span>,<span class="st">"Twilight"</span><span class="op">)</span><span class="op">]</span>

<span class="co"># hour column</span>
<span class="va">res_twi</span><span class="op">[</span>, <span class="va">hour</span> <span class="op">:=</span> <span class="fu">hour</span><span class="op">(</span><span class="va">Twilight</span><span class="op">)</span><span class="op">]</span>

<span class="co"># display the result</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_tile</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dataPlot</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, fill <span class="op">=</span> <span class="va">lightatsurf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">res_twi</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, col <span class="op">=</span> <span class="va">Rise</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">.id</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_jjo</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"# of days since departure"</span>, 
       y <span class="op">=</span> <span class="st">"Hour"</span>, 
       fill <span class="op">=</span> <span class="st">"Light level at the surface"</span>, 
       col <span class="op">=</span> <span class="st">"Sunrise"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="phase_of_the_day_files/figure-html/phase-of-the-day-4-1.png" alt="Visualization of light level at the surface along 2018-individuals' trip, with twilight detection points" width="100%"><p class="caption">
Visualization of light level at the surface along 2018-individuals’ trip, with twilight detection points
</p>
</div>
<p>Not bad actually! But there are many outliers that need to be addressed. Let’s try to only keep the pair <code>Rise</code> (<code>TRUE</code>, <code>FALSE</code>) that has the longer period of time of the day.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># calculate the period of time between a sunrise and a sunset (i.e. two consecutive rows)</span>
<span class="va">res_twi</span><span class="op">[</span>, <span class="va">period_time</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">Twilight</span>,units<span class="op">=</span><span class="st">"hours"</span><span class="op">)</span>, units<span class="op">=</span><span class="st">"mins"</span><span class="op">)</span><span class="op">)</span>, 
        by<span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">.id</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">Twilight</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>

<span class="co"># keep only the longer period of time and the row just before</span>
<span class="va">res_twi_inter</span> <span class="op">=</span> <span class="va">res_twi</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
  <span class="co"># index of row with the longer period of time </span>
  <span class="va">res_twi</span><span class="op">[</span>, <span class="va">.I</span><span class="op">[</span><span class="va">period_time</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">period_time</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">.id</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">Twilight</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">V1</span>,
  <span class="co"># index of the row previous the one with the longer period of time  </span>
  <span class="va">res_twi</span><span class="op">[</span>, <span class="va">.I</span><span class="op">[</span><span class="va">period_time</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">period_time</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">.id</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">Twilight</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">V1</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>
  <span class="co"># reorder by date</span>
  <span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">Twilight</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># display the result</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_tile</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dataPlot</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, fill <span class="op">=</span> <span class="va">lightatsurf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">res_twi_inter</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, col <span class="op">=</span> <span class="va">Rise</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">.id</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_jjo</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"# of days since departure"</span>, 
       y <span class="op">=</span> <span class="st">"Hour"</span>, 
       fill <span class="op">=</span> <span class="st">"Light level at the surface"</span>, 
       col <span class="op">=</span> <span class="st">"Sunrise"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="phase_of_the_day_files/figure-html/phase-of-the-day-6-1.png" alt="Visualization of light level at the surface along 2018-individuals' trip, with twilight detection points corrected" width="100%"><p class="caption">
Visualization of light level at the surface along 2018-individuals’ trip, with twilight detection points corrected
</p>
</div>
<p>That’s definitely better, but there are few remaining outliers (especially for the individual <code>ind_2018074</code>). Let’s zoom in the first days since departure for this individual, to see what’s going on.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># display the result</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_tile</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dataPlot</span><span class="op">[</span><span class="va">.id</span> <span class="op">==</span> <span class="st">"ind_2018074"</span> <span class="op">&amp;</span> <span class="va">day_departure</span> <span class="op">&lt;</span> <span class="fl">100</span>,<span class="op">]</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, fill <span class="op">=</span> <span class="va">lightatsurf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">res_twi_inter</span><span class="op">[</span><span class="va">.id</span> <span class="op">==</span> <span class="st">"ind_2018074"</span> <span class="op">&amp;</span> <span class="va">day_departure</span> <span class="op">&lt;</span> <span class="fl">100</span><span class="op">]</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, col <span class="op">=</span> <span class="va">Rise</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_jjo</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"# of days since departure"</span>, 
       y <span class="op">=</span> <span class="st">"Hour"</span>, 
       fill <span class="op">=</span> <span class="st">"Light level at the surface"</span>, 
       col <span class="op">=</span> <span class="st">"Sunrise"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"top"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="phase_of_the_day_files/figure-html/zoom_2010074-1.png" alt="Visualization of light level at the surface for the first 100 days of `ind_2018074`, with twilight detection points corrected" width="100%"><p class="caption">
Visualization of light level at the surface for the first 100 days of <code>ind_2018074</code>, with twilight detection points corrected
</p>
</div>
<p>As we can see, some low light levels are encountered in the middle of daytime that mislead the <code>findTwilight</code> function in finding the sunrise or the sunset. Two ways could be explored to deal with these outliers:</p>
</div>
<div class="section level2 unlisted unnumbered tabset">
<h2 class="unlisted unnumbered tabset" id="section"></h2>


<ul class="nav nav-tabs" id="section" role="tablist">
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#adding-a-condition-on-the-distribution-of-period_time" id="adding-a-condition-on-the-distribution-of-period_time-tab" type="button" role="tab" aria-controls="adding-a-condition-on-the-distribution-of-period_time" aria-selected="true" class="active nav-link">Adding a condition on the distribution of <code>period_time</code></button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#smoothing-light-level-signal" id="smoothing-light-level-signal-tab" type="button" role="tab" aria-controls="smoothing-light-level-signal" aria-selected="false" class="nav-link">Smoothing light level signal</button></li>
</ul>
<div class="tab-content">
<div class="active  tab-pane" id="adding-a-condition-on-the-distribution-of-period_time" role="tabpanel" aria-labelledby="adding-a-condition-on-the-distribution-of-period_time-tab">

<p>Since some of the outliers observed Figure @ref(fig:zoom_2010074) are during daytime, it means that <code>period_time</code> should be longer than usual for these days. Considering this, we could impose condition on this variable to make sure it is neither too long either too short.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># display</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">res_twi_inter</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">period_time</span>, fill<span class="op">=</span><span class="va">.id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_histogram</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">.id</span><span class="op">~</span><span class="va">.</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">theme_jjo</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="phase_of_the_day_files/figure-html/phase-of-the-day-7-1.png" alt="Distributions of the time difference between two rows identified as sunrise and sunset" width="100%"><p class="caption">
Distributions of the time difference between two rows identified as sunrise and sunset
</p>
</div>
<p>Considering this graph, let’s try to keep rows where <code>period_time==0</code> or <code>300&lt;period_time&lt;900</code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># remove outlier (but keep the 0)</span>
<span class="va">res_twi_out</span> <span class="op">=</span> <span class="va">res_twi</span><span class="op">[</span><span class="va">period_time</span><span class="op">==</span><span class="fl">0</span> <span class="op">|</span> <span class="va">period_time</span> <span class="op">%between%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">300</span>,<span class="fl">900</span><span class="op">)</span><span class="op">]</span>

<span class="co"># keep only the longer period of time and the row just before</span>
<span class="va">res_twi_out_inter</span> <span class="op">=</span> <span class="va">res_twi_out</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
  <span class="co"># index of row with the longer period of time </span>
  <span class="va">res_twi_out</span><span class="op">[</span>, <span class="va">.I</span><span class="op">[</span><span class="va">period_time</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">period_time</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">.id</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">Twilight</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">V1</span>,
  <span class="co"># index of the row previous the one with the longer period of time  </span>
  <span class="va">res_twi_out</span><span class="op">[</span>, <span class="va">.I</span><span class="op">[</span><span class="va">period_time</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">period_time</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">.id</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">Twilight</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">V1</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>
  <span class="co"># reorder by date</span>
  <span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">Twilight</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># display the result</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_tile</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dataPlot</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, fill <span class="op">=</span> <span class="va">lightatsurf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">res_twi_out_inter</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, col <span class="op">=</span> <span class="va">Rise</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">.id</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_jjo</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"# of days since departure"</span>, 
       y <span class="op">=</span> <span class="st">"Hour"</span>, 
       fill <span class="op">=</span> <span class="st">"Light level at the surface"</span>, 
       col <span class="op">=</span> <span class="st">"Sunrise"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="phase_of_the_day_files/figure-html/phase-of-the-day-9-1.png" alt="Visualization of light level at the surface along 2018-individuals' trip, with twilight detection points corrected" width="100%"><p class="caption">
Visualization of light level at the surface along 2018-individuals’ trip, with twilight detection points corrected
</p>
</div>
<blockquote>
<p>This does not work! If several sunset and sunrise are identified within a day, the current algorithm will only calculates <code>period_time</code> between two successive rows, whereas we should test every possible combination.</p>
</blockquote>
</div>
<div class="tab-pane" id="smoothing-light-level-signal" role="tabpanel" aria-labelledby="smoothing-light-level-signal-tab">

<p>Since those points are due to outliers during the day, we could try to smooth the light level signal and run the <code>findTwilight</code> function on it.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># # let's first split our dataset by individual</span>
<span class="co"># split_inter = split(data_2018, data_2018$.id)</span>
<span class="co"># </span>
<span class="co"># # create a times series of ligth level</span>
<span class="co"># split_inter = lapply(split_inter, function(x) {</span>
<span class="co">#   # summerize data at the min level</span>
<span class="co">#   df = x[,.(lightatsurf = median(lightatsurf, na.rm=T)), by=.(date = floor_date(date, unit="min"))]</span>
<span class="co">#   # creation of a time series</span>
<span class="co">#   z = as.ts(zoo(df$lightatsurf, df$date))</span>
<span class="co">#   # smoother creation</span>
<span class="co">#   # https://boostedml.com/2020/05/an-introduction-to-time-series-smoothing-in-r.html</span>
<span class="co">#   s = ksmooth(time(z),as.numeric(z),'normal',bandwidth=6)</span>
<span class="co">#   # retrieve smooth value</span>
<span class="co">#   x[, lightatsurf_smooth := s$y]</span>
<span class="co"># })</span>
<span class="co"># </span>
<span class="co"># # unlist</span>
<span class="co"># data_2018 = rbindlist(split_inter)</span></code></pre></div>
<blockquote>
<p>So far, I have not been successful using this method cause it seems quite tricky to smooth a signal with a lot of missing values.</p>
</blockquote>
</div>
</div>
</div>
<div class="section level2">
<h2 id="lets-try-a-clustering-method">Let’s try a clustering method<a class="anchor" aria-label="anchor" href="#lets-try-a-clustering-method"></a>
</h2>
<p>Since we can visually see where is the day and night time, we should try clustering method.</p>
<div class="section level3">
<h3 id="k-means-hierarchical-clustering">K-MEANS + Hierarchical clustering<a class="anchor" aria-label="anchor" href="#k-means-hierarchical-clustering"></a>
</h3>
<p>Here we test a package well-known to perform clustering <code>FactoMineR</code>. The idea behind its main method is to performed a hierarchical clustering where the initial centroids are positioned based on a pre-performed k-means using the first component of a PCA. For more information feel free to have a look at their <a href="http://factominer.free.fr/factomethods/hierarchical-clustering-on-principal-components.html" class="external-link">website</a>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># remove nan value</span>
<span class="va">df_clust</span> <span class="op">=</span> <span class="va">dataPlot</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">lightatsurf</span><span class="op">)</span>,<span class="fu">.</span><span class="op">(</span><span class="va">hour</span>,<span class="va">day_departure</span>,<span class="va">lightatsurf</span><span class="op">)</span><span class="op">]</span>
                    
<span class="co"># HCPC with onlys 2 groups</span>
<span class="va">res_hcpc</span> <span class="op">=</span> <span class="fu">FactoMineR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FactoMineR/man/HCPC.html" class="external-link">HCPC</a></span><span class="op">(</span><span class="va">df_clust</span>, nb.clust <span class="op">=</span> <span class="fl">2</span>, graph <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># display the result</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_tile</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dataPlot</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">lightatsurf</span><span class="op">)</span>,
                            <span class="op">]</span><span class="op">[</span>,<span class="va">cluster</span><span class="op">:=</span><span class="va">res_hcpc</span><span class="op">$</span><span class="va">data.clust</span><span class="op">$</span><span class="va">clust</span><span class="op">]</span>, 
            <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">theme_jjo</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">.id</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"# of days since departure"</span>, 
       y <span class="op">=</span> <span class="st">"Hour"</span>, 
       fill <span class="op">=</span> <span class="st">"cluster"</span>, 
       col <span class="op">=</span> <span class="st">"Sunrise"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="phase_of_the_day_files/figure-html/phase-of-the-day-11-1.png" alt="Visualization of the moment where the light was measured at the surface colored with the associated cluster (HCPC)" width="100%"><p class="caption">
Visualization of the moment where the light was measured at the surface colored with the associated cluster (HCPC)
</p>
</div>
<p>Well, clearly this algorithm is not suited to deal with this kind of patterns!</p>
</div>
<div class="section level3">
<h3 id="dbscan">
<a href="https://en.wikipedia.org/wiki/DBSCAN" class="external-link">DBSCAN</a><a class="anchor" aria-label="anchor" href="#dbscan"></a>
</h3>
<p>DBSCAN seems to be an <a href="http://www.sthda.com/english/wiki/wiki.php?id_contents=7940" class="external-link">elegant</a> algorithm to deal with outliers and non-convex cluster. The only <strong>issue</strong> is that we have to choose the right value for its two parameters:</p>
<ul>
<li>Reachability distance</li>
<li>Reachability minimum number of points</li>
</ul>
<p>Which might be tricky!</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># determine the right values by testing several of them...</span>
<span class="va">res_dbscan</span> <span class="op">=</span> <span class="fu">dbscan</span><span class="op">(</span><span class="va">df_clust</span>,
            eps <span class="op">=</span> <span class="fl">45</span>,
            MinPts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dataPlot</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.06</span>,
            method <span class="op">=</span> <span class="st">"raw"</span><span class="op">)</span>

<span class="co"># display the result</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_tile</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dataPlot</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">lightatsurf</span><span class="op">)</span>,
                            <span class="op">]</span><span class="op">[</span>,<span class="va">cluster</span><span class="op">:=</span><span class="va">res_dbscan</span><span class="op">$</span><span class="va">cluster</span><span class="op">]</span>,
            <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_jjo</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">.id</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"# of days since departure"</span>,
       y <span class="op">=</span> <span class="st">"Hour"</span>,
       fill <span class="op">=</span> <span class="st">"cluster"</span>,
       col <span class="op">=</span> <span class="st">"Sunrise"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="phase_of_the_day_files/figure-html/dbscan_first_test-1.png" alt="Visualization of the moment where the light was measured at the surface colored with the associated cluster (DBSCAN, `eps=45`, `MinPts=nrow(dataPlot)*0.06`)" width="100%"><p class="caption">
Visualization of the moment where the light was measured at the surface colored with the associated cluster (DBSCAN, <code>eps=45</code>, <code>MinPts=nrow(dataPlot)*0.06</code>)
</p>
</div>
<p>Well that’s quite nice :) There are still few outliers (especially for individual <code>ind_201874</code>) identify as cluster 1 whereas we would like to see them in cluster 2. Let’s try using other parameters.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># let's try other parameters</span>
<span class="va">res_dbscan</span> <span class="op">=</span> <span class="fu">dbscan</span><span class="op">(</span><span class="va">df_clust</span>, 
                  eps <span class="op">=</span> <span class="fl">8</span>, 
                  MinPts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dataPlot</span><span class="op">)</span><span class="op">*</span><span class="fl">0.001</span>, 
                  method <span class="op">=</span> <span class="st">"raw"</span><span class="op">)</span>

<span class="co"># display the result</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_tile</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dataPlot</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">lightatsurf</span><span class="op">)</span>,
                            <span class="op">]</span><span class="op">[</span>,<span class="va">cluster</span><span class="op">:=</span><span class="va">res_dbscan</span><span class="op">$</span><span class="va">cluster</span><span class="op">]</span>, 
            <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">theme_jjo</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">.id</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"# of days since departure"</span>, 
       y <span class="op">=</span> <span class="st">"Hour"</span>, 
       fill <span class="op">=</span> <span class="st">"cluster"</span>, 
       col <span class="op">=</span> <span class="st">"Sunrise"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="phase_of_the_day_files/figure-html/phase-of-the-day-12-1.png" alt="Visualization of the moment where the light was measured at the surface colored with the associated cluster (DBSCAN, `eps=8`, `MinPts=nrow(dataPlot)*0.0001`)" width="100%"><p class="caption">
Visualization of the moment where the light was measured at the surface colored with the associated cluster (DBSCAN, <code>eps=8</code>, <code>MinPts=nrow(dataPlot)*0.0001</code>)
</p>
</div>
<p>Here, the algorithm find several clusters, but it is the cluster <code>1</code> that has our attention. It seems better defined than the previous figure @ref(fig:dbscan_first_test), but there are still few rows (for <code>ind_2018074</code>) that have been mislabelled.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># display the result</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_tile</span><span class="op">(</span>data <span class="op">=</span> <span class="va">dataPlot</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">lightatsurf</span><span class="op">)</span>,
                            <span class="op">]</span><span class="op">[</span>,<span class="va">cluster</span><span class="op">:=</span><span class="va">res_dbscan</span><span class="op">$</span><span class="va">cluster</span>
                              <span class="op">]</span><span class="op">[</span>,<span class="va">cluster</span><span class="op">:=</span><span class="fu">fifelse</span><span class="op">(</span><span class="va">cluster</span><span class="op">==</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span>, 
            <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">day_departure</span>, y <span class="op">=</span> <span class="va">hour</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">theme_jjo</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">.id</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"# of days since departure"</span>, 
       y <span class="op">=</span> <span class="st">"Hour"</span>, 
       fill <span class="op">=</span> <span class="st">"cluster"</span>, 
       col <span class="op">=</span> <span class="st">"Sunrise"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="phase_of_the_day_files/figure-html/phase-of-the-day-13-1.png" alt="Same as above, but `cluster 1 = cluster 1`, `cluster 2 = all the others`" width="100%"><p class="caption">
Same as above, but <code>cluster 1 = cluster 1</code>, <code>cluster 2 = all the others</code>
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>For now we will used the result from the <code>DBSCAN</code> algorithm, since results seem to be better!</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># referential creation</span>
<span class="va">ref_phase_day</span> <span class="op">=</span> <span class="va">dataPlot</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">lightatsurf</span><span class="op">)</span>,
         <span class="op">]</span><span class="op">[</span>, <span class="va">cluster</span> <span class="op">:=</span> <span class="va">res_dbscan</span><span class="op">$</span><span class="va">cluster</span>
           <span class="op">]</span><span class="op">[</span>, <span class="va">cluster</span> <span class="op">:=</span> <span class="fu">fifelse</span><span class="op">(</span><span class="va">cluster</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"night"</span>, <span class="st">"day"</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="op">]</span>

<span class="co"># reshape</span>
<span class="va">ref_phase_day</span> <span class="op">=</span> <span class="fu">melt</span><span class="op">(</span><span class="va">ref_phase_day</span>, 
                     id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">".id"</span>,<span class="st">"date"</span>,<span class="st">"hour"</span><span class="op">)</span>, 
                     measure.vars <span class="op">=</span> <span class="st">"cluster"</span>, 
                     value.name <span class="op">=</span> <span class="st">"phase"</span><span class="op">)</span>

<span class="co"># set date format</span>
<span class="va">ref_phase_day</span><span class="op">[</span>, <span class="fu">`:=`</span> <span class="op">(</span>date <span class="op">=</span> <span class="va">date</span> <span class="op">+</span> <span class="fu">hours</span><span class="op">(</span><span class="va">hour</span><span class="op">)</span>,
                      hour <span class="op">=</span> <span class="cn">NULL</span>,
                      variable <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">]</span>

<span class="co"># rolling join</span>
<span class="va">data_2018</span> <span class="op">=</span> <span class="va">ref_phase_day</span><span class="op">[</span><span class="va">data_2018</span>, roll<span class="op">=</span><span class="cn">T</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">.id</span>, <span class="va">date</span><span class="op">)</span><span class="op">]</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="wip">WIP<a class="anchor" aria-label="anchor" href="#wip"></a>
</h2>
<p>We could also try to define two other phases of the day:</p>
<ul>
<li>sunset: plus or minus 30 min from the transition night to day</li>
<li>sunrise: plus or minus 30 min from the transition day to night</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># identification of transition</span>
<span class="va">ref_phase_day</span><span class="op">[</span>,<span class="va">transition</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">phase</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>

<span class="co"># keep only the first date and the last date (i.e transition) by date and individual</span>
<span class="va">ref_phase_day</span> <span class="op">=</span> <span class="va">ref_phase_day</span><span class="op">[</span><span class="va">transition</span><span class="op">==</span><span class="fl">1</span>, <span class="va">.SD</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">.N</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">.id</span>,<span class="va">date</span><span class="op">)</span><span class="op">]</span>

<span class="co"># convert date to take into account hour</span>
<span class="va">ref_phase_day</span><span class="op">[</span>, <span class="va">date</span><span class="op">:=</span><span class="va">date</span><span class="op">+</span><span class="fu">hours</span><span class="op">(</span><span class="va">hour</span><span class="op">)</span><span class="op">]</span>

<span class="co"># add sunset</span>
<span class="va">test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">ref_phase_day</span><span class="op">[</span>,<span class="va">.SD</span>,.SDcols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"transition"</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="va">date</span><span class="op">:=</span> <span class="va">date</span><span class="op">+</span><span class="fu">minutes</span><span class="op">(</span><span class="fl">30</span><span class="op">)</span><span class="op">]</span>,
             <span class="va">ref_phase_day</span><span class="op">[</span>,<span class="va">.SD</span>,.SDcols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"transition"</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="va">phase</span><span class="op">==</span><span class="st">"night"</span>,<span class="op">]</span><span class="op">[</span>, <span class="va">date</span> <span class="op">:=</span> <span class="va">date</span> <span class="op">-</span> <span class="fu">minutes</span><span class="op">(</span><span class="fl">30</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>,<span class="va">phase</span><span class="op">:=</span><span class="st">"sunset"</span><span class="op">]</span>,
             <span class="va">ref_phase_day</span><span class="op">[</span>,<span class="va">.SD</span>,.SDcols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"transition"</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="va">phase</span><span class="op">==</span><span class="st">"day"</span>,<span class="op">]</span><span class="op">[</span>, <span class="va">date</span> <span class="op">:=</span> <span class="va">date</span> <span class="op">-</span> <span class="fu">minutes</span><span class="op">(</span><span class="fl">30</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>,<span class="va">phase</span><span class="op">:=</span><span class="st">"sunrise"</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<blockquote>
<p>Problem, when there are no day times found during several days, there all marked as night!</p>
</blockquote>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;ved=2ahUKEwic8O6l9bH0AhXMJjQIHZ-HBMIQFnoECAIQAQ&amp;url=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fjoffreyjoumaa&amp;usg=AOvVaw2R2txhLGptY1KcDYL9VUrK" class="external-link">Joffrey Joumaa</a>, <a href="https://roxannebeltran.weebly.com/people.html" class="external-link">Roxanne Beltran</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.9000.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
