---
title: "Data Exploration NES - 2016"
author: "Joffrey JOUMAA"
date: "`r invisible(Sys.setlocale(locale = 'C')); format(Sys.Date(), format = '%B %d, %Y')`"
output:
  bookdown::html_document2:
    css: cosmo_custom.css
    number_sections: yes
    code_folding: show
    df_print: default
    fig_caption: yes
    code_download: yes
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
link-citations: yes
pkgdown:
  as_is: false
vignette: >
  %\VignetteIndexEntry{Data Exploration NES - 2016}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include=FALSE}
# command to build package without getting vignette error
# https://github.com/rstudio/renv/issues/833
# devtools::check(build_args=c("--no-build-vignettes"))

# reduce png size
knitr::knit_hooks$set(optipng = knitr::hook_optipng)
knitr::knit_hooks$set(pngquant = knitr::hook_pngquant)

# global option relative to rmarkdown
knitr::opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  fig.align = "center",
  out.width = "100%",
  message = FALSE,
  warning = FALSE,
  # tidy = TRUE,
  optipng = "-o7 -quiet",
  pngquant = "--speed=1"
)

# library
library(data.table)
library(ggplot2)
library(kableExtra)
library(leaflet)
library(gtsummary) # https://cran.r-project.org/web/packages/gtsummary/vignettes/tbl_summary.html
library(corrplot)
library(ggcorrplot)
library(ggnewscale)
library(magrittr)
library(DT)
library(plotly)
library(geosphere)

# remove some warnings
suppressWarnings(library(ggplot2))

# define my own table format: https://github.com/haozhu233/kableExtra/issues/374
sable <- function(x, escape = T, ...) {
  knitr::kable(x, escape = escape, ...) %>%
    kable_styling(
      bootstrap_options = c("striped", "hover", "responsive"),
      full_width = F
    )
}
```

This document aims at exploring the dataset of 6 individuals in 2016. For that purpose, we need first to load the `weanlingNES` package to load data.

```{r data-exploration-2016-1}
# load library
library(weanlingNES)

# load data
data("data_nes", package = "weanlingNES")
```

Let's have a look at what's inside `data_nes$data_2016`:
  
```{r data-exploration-2016-2}
# list structure
str(data_nes$year_2016, max.level = 1, give.attr = F, no.list = T)
```

> A list of `r length(data_nes$year_2016)` `data.frames`, one for each seal

For convenience, we aggregate all `r length(data_nes$year_2016)` individuals into one dataset.

```{r data-exploration-2016-3, eval=FALSE}
# combine all individuals
data_2016 <- rbindlist(data_nes$year_2016, use.name = TRUE, idcol = TRUE)

# display
DT::datatable(data_2016[sample.int(.N, 100), ], options = list(scrollX = T))
```
```{r data-exploration-2016-4, echo=FALSE, results='asis'}
# combine all individuals
data_2016 <- rbindlist(data_nes$year_2016, use.name = TRUE, idcol = TRUE)

# title
cat("<table style='width: 50%'>", paste0("<caption>", "(#tab:myDThtmltools)", "Sample of 100 random rows from `data_2016`", "</caption>"), "</table>", sep = "\n")

# display
DT::datatable(data_2016[sample.int(.N, 100), ], options = list(scrollX = T))
```

# Summary

```{r data-exploration-2016-5}
# raw_data
data_2016[, .(
  nb_days_recorded = uniqueN(as.Date(date)),
  max_depth = max(maxpress_dbars),
  sst_mean = mean(sst2_c),
  sst_sd = sd(sst2_c)
), by = .id] %>%
  sable(
    caption = "Summary diving information relative to each 2016 individual",
    digits = 2
  )
```

Well, it seems that `sst` is a bit odd. Let's have a look at its distribution.

```{r data-exploration-2016-6, fig.cap="Distribution of raw `sst2` for the four individuals in 2016"}
ggplot(data_2016, aes(x = sst2_c, fill = .id)) +
  geom_histogram(show.legend = FALSE) +
  facet_wrap(.id ~ .) +
  theme_jjo()
```

Let's remove any data with a `sst2_c` > 500.

```{r data-exploration-2016-7, fig.cap="Distribution of filtered `sst2` for the four individuals in 2016"}
data_2016_filter <- data_2016[sst2_c < 500, ]
ggplot(data_2016_filter, aes(x = sst2_c, fill = .id)) +
  geom_histogram(show.legend = FALSE) +
  facet_wrap(.id ~ .) +
  theme_jjo()
```

Well, that seems to be much better! In the process of filtering out odd values, we removed `r data_2016[,.N] - data_2016_filter[,.N]` rows this way:

```{r data-exploration-2016-8}
# nbrow removed
data_2016[sst2_c > 500, .(nb_row_removed = .N), by = .id] %>%
  sable(caption = "# of rows removed by 2016-individuals")
```
```{r data-exploration-2016-9, fig.cap="Where and when the `sst2` outliers occured", fig.width=9}
# max depth
ggplot(
  data_2016,
  aes(y = -maxpress_dbars, x = as.Date(date), col = .id)
) +
  geom_path(show.legend = FALSE) +
  geom_point(data = data_2016[sst2_c > 500, ], col = "black") +
  scale_x_date(date_labels = "%m/%Y") +
  labs(y = "Pressure (dbar)", x = "Date") +
  facet_wrap(.id ~ .) +
  theme_jjo() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Well this latter plot highlights several points:

* most of the outliers occur while animals spend the whole day at the surface (or on the ground), probably resting, so essentially at the beginning and the end of each track
* we can already see that `ind_3449` seems to have return ashore twice during his track

Let's see if we can double check that, using a map.

```{r data-exploration-2016-10, fig.cap="It is supposed to be the track of `ind_3449`... (red dots are the location of removed rows)", fig.width=8}
# interactive map
# htmltools::tagList(list(
  leaflet() %>%
    setView(lng = -122, lat = 38, zoom = 2) %>%
    addTiles() %>%
    addPolylines(
      lat = data_2016[.id == "ind_3449", latitude_degs],
      lng = data_2016[.id == "ind_3449", longitude_degs],
      weight = 2
    ) %>%
    addCircleMarkers(
      lat = data_2016[.id == "ind_3449" & sst2_c > 500, latitude_degs],
      lng = data_2016[.id == "ind_3449" &
                        sst2_c > 500, longitude_degs],
      radius = 3,
      stroke = FALSE,
      color = "red",
      fillOpacity = 1
    )
# ))
```

... these coordinates seem weird !

```{r data-exploration-2016-11}
# summary of the coordinates by individuals
data_2016[, .(.id, longitude_degs, latitude_degs)] %>%
  tbl_summary(by = .id) %>%
  modify_caption("Summary of `longitude_degree` and `latitude_degree`")
```

```{r data-exploration-2016-12, fig.width=9, fig.cap="Distribution of coordinates per seal"}
# distribution coordinates
ggplot(
  data = melt(data_2016[, .(
    Longitude = longitude_degs,
    Latitude = latitude_degs,
    .id
  )],
  id.vars =
    ".id", value.name = "Coordinate"
  ),
  aes(x = Coordinate, fill = .id)
) +
  geom_histogram(show.legend = F) +
  facet_grid(variable ~ .id) +
  theme_jjo()
```

There is definitely something wrong with these coordinates (five seals would have crossed the equator...), but the representation of the track can also be improved! Here are the some points to explore:

* For `longitude` a part of the data seems to have a wrong sign, resulting in these distribution, that appear to be cut off
* For `latitude`, well this is ensure but maybe the same problem occurs

Let's try to play on coordinates' sign to see if we can display something that makes more sense.

```{r data-exploration-2016-13, fig.cap="An attempt to display the `ind_3449`'s track", fig.width=8}
# interactive map
htmltools::tagList(list(
  leaflet() %>%
    setView(lng = -122, lat = 50, zoom = 3) %>%
    addTiles() %>%
    addPolylines(
      lat = data_2016[.id == "ind_3449", abs(latitude_degs)],
      lng = data_2016[.id == "ind_3449",-abs(longitude_degs)],
      weight = 2
    )
))
```

> I'll better ask Roxanne!
  
# Missing values
  
```{r data-exploration-2016-14, fig.cap="Check for missing value in 2016-individuals", out.width="100%"}
# build dataset to check for missing values
dataPlot <- melt(data_2016_filter[, .(.id, is.na(.SD)), .SDcol = -c(
  ".id",
  "rec#",
  "date",
  "time"
)])
# add the id of rows
dataPlot[, id_row := c(1:.N), by = c("variable", ".id")]

# plot
ggplot(dataPlot, aes(x = variable, y = id_row, fill = value)) +
  geom_tile() +
  labs(x = "Attributes", y = "Rows") +
  scale_fill_manual(
    values = c("white", "black"),
    labels = c("Real", "Missing")
  ) +
  facet_wrap(.id ~ ., scales = "free_y") +
  theme_jjo() +
  theme(
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.key = element_rect(colour = "black")
  )
```
