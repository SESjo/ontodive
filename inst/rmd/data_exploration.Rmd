---
title: "Data Exploration"
author: "Joffrey JOUMAA"
date: "`r format(Sys.Date(), format = '%d %B %Y')`"
output:
  bookdown::html_document2:
    css: cosmo_custom.css
    number_sections: yes
    code_folding: show
    df_print: default
    fig_caption: yes
    code_download: yes
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
---

```{r setup, include=FALSE}
# global option relative to rmarkdown
knitr::opts_chunk$set(echo = TRUE,
                      fig.align = 'center',
                      message = FALSE)

# library
library(data.table)
library(ggplot2)
library(kableExtra)
library(leaflet) 
library(gtsummary) #https://cran.r-project.org/web/packages/gtsummary/vignettes/tbl_summary.html

# define my own table format: https://github.com/haozhu233/kableExtra/issues/374
sable <- function(x, escape = T, ...) {
  knitr::kable(x, escape = escape, ...) %>%
    kable_styling(
      bootstrap_options = c("striped", "hover", "responsive"),
      full_width = F
    )
}

# theme ggplot
# based: https://benjaminlouis-stat.fr/en/blog/2020-05-21-astuces-ggplot-rmarkdown/
theme_jjo <- function(base_size = 12) {
  theme_bw(base_size = base_size) %+replace%
    theme(
      # the whole figure
      #plot.title = element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
      # figure area
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      # axes
      #axis.title = element_text(size = rel(0.85), face = "bold"),
      #axis.text = element_text(size = rel(0.70), face = "bold"),
      axis.line = element_line(color = "black", arrow = arrow(length = unit(0.2, "lines"), type = "closed")),
      # legend
      # legend.title = element_text(size = rel(0.85), face = "bold"),
      # legend.text = element_text(size = rel(0.70), face = "bold"),
      # legend.key = element_rect(fill = "transparent", colour = NA),
      # legend.key.size = unit(1.5, "lines"),
      # legend.background = element_rect(fill = "transparent", colour = NA),
      # Les étiquettes dans le cas d'un facetting
       strip.background = element_rect(fill = "#888888", color = "#888888"),
       strip.text = element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
    )
}
```

This document aims at exploring two datasets, one in 2016 on 6 individuals and another one in 2018 on 4 individuals. For that purpose, we need first to load the `weanlingNES` package to load data.

```{r}
# load library
library(weanlingNES)

# load data
data("data_nes", package = "weanlingNES")
```


# 2016-individuals 

Let's have a look at what's inside `data_nes$data_2016`:

```{r}
# list structure
str(data_nes$year_2016, max.level = 1, give.attr = F, no.list = T)
```

> A list of `r length(data_nes$data_2016)` `data.frames`, one for each seal

For convenience, we aggregate all `r length(data_nes$data_2016)` individuals into one dataset.

```{r, eval=FALSE}
# combine all individuals
data_2016 = rbindlist(data_nes$year_2016, use.name = TRUE, idcol = TRUE)

# display
DT::datatable(data_2016[sample.int(.N,100),],options=list(scrollX=T))
```
```{r, echo=FALSE, results='asis'}
# combine all individuals
data_2016 = rbindlist(data_nes$year_2016, use.name = TRUE, idcol = TRUE)

# title
cat("<table style='width: 50%'>",paste0("<caption>", "(#tab:myDThtmltools)", "Sample of 100 random rows from `data_2016`", "</caption>"),"</table>", sep ="\n")

# display
DT::datatable(data_2016[sample.int(.N,100),],options=list(scrollX=T))
```
 
## Summary

```{r}
# raw_data
data_2016[, .(
  nb_days_recorded = uniqueN(as.Date(date)),
  max_depth = max(maxpress_dbars),
  sst_mean = mean(sst2_c),
  sst_sd = sd(sst2_c)
), by =.id] %>%
  sable(caption="Summary diving information relative to each 2016 individual", 
        digits=2)
```

Well, it seems that `sst` is a bit odd. Let's have a look at its distribution.


```{r, fig.cap="Distribution of raw `sst2` for the four individuals in 2016"}
ggplot(data_2016, aes(x = sst2_c, fill = .id)) +
  geom_histogram(show.legend = FALSE) +
  facet_wrap(.id ~ .) +
  theme_jjo()
```

Let's remove any data with a `sst2_c` > 500.

```{r, fig.cap="Distribution of filtered `sst2` for the four individuals in 2016"}
data_2016_filter = data_2016[sst2_c < 500, ]
ggplot(data_2016_filter, aes(x = sst2_c, fill = .id)) +
  geom_histogram(show.legend = FALSE) +
  facet_wrap(.id ~ .) +
  theme_jjo()
```

Well,that seems to be much better! In the process of filtering out odd values, we removed `r data_2016[,.N] - data_2016_filter[,.N]` rows this way:

```{r}
# nbrow removed
data_2016[sst2_c>500,.(nb_row_removed = .N),by=.id] %>%
  sable(caption = "# of rows removed by indivduals")
```
```{r, fig.cap="Where and when the `sst2` outliers occured", fig.width=9}
ggplot(data_2016,
       aes(y = -maxpress_dbars, x=as.Date(date), col=.id)) +
  geom_path(show.legend = FALSE) +
  geom_point(data = data_2016[sst2_c>500,], col="black") +
  scale_x_date(date_labels = "%m/%Y") +
  labs(y="Pressure (dbar)", x="Date") +
  facet_wrap(.id ~ .) +
  theme_jjo() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```
Well this latter plot highlights several points:

* most of the outliers occur while animals spend the whole day at the surface (or on the ground), probably resting, so essentially at the beginning and the end of each track
* we can already see that `ind_3449` seems to have return ashore twice during his track

Let's see if we can double check that using some maps.

```{r, fig.cap="It is supposed to be the track of `ind_3449`... (red dots are the location of removed rows)", fig.width=8}
# interactive map
leaflet() %>%
  setView(lng = -122, lat = 38, zoom = 2) %>%
  addTiles() %>%
  addPolylines(lat = data_2016[.id == "ind_3449", latitude_degs],
               lng = data_2016[.id == "ind_3449", longitude_degs],
               weight = 2) %>%
  addCircleMarkers(lat = data_2016[.id == "ind_3449" & sst2_c>500, latitude_degs],
                   lng = data_2016[.id == "ind_3449" & sst2_c>500, longitude_degs],
                   radius = 3,
                   stroke=FALSE,
                   color="red",
                   fillOpacity=1)
```

... these coordinates seem weird !

```{r}
# summary of the coordinates by individuals
data_2016[, .(.id, longitude_degs, latitude_degs)] %>%
  tbl_summary(by = .id) %>%
  modify_caption("Summary of `longitude_degree` and `latitude_degree`")
```

```{r, fig.width=9, fig.cap="Distribution of coordinates per seal"}
# distribution coordinates
ggplot(
  data = melt(data_2016[, .(Longitude = longitude_degs, 
                            Latitude = latitude_degs, 
                            .id)], id.vars =
                ".id", value.name = "Coordinate"),
  aes(x = Coordinate, fill = .id)
) +
  geom_histogram(show.legend = F) +
  facet_grid(variable ~ .id) +
  theme_jjo()
```

There is definitely something wrong with these coordinates (five of the seals would have crossed the equator...), but the representation of the track can also be improved! Here are the some points to explore:

* For `longitude` a part of the data seems to have the wrong sign, resulting in these distribution that appear to be cut off
* For `latitude`, well this is ensure but maybe the same problem occur

Let's try to play on coordinates' sign to see if we can display something that makes more sense.

```{r, fig.cap="An attempt to display the `ind_3449`'s track", fig.width=8}
# interactive map
leaflet() %>%
  setView(lng = -122, lat = 50, zoom = 3) %>%
  addTiles() %>%
  addPolylines(lat = data_2016[.id == "ind_3449", abs(latitude_degs)],
               lng = data_2016[.id == "ind_3449", -abs(longitude_degs)],
               weight = 2)
```

> I'll better ask Roxanne!


# 2018-individuals

Let’s have a look at what’s inside `data_nes$data_2018`:

```{r}
# list structure
str(data_nes$year_2018, max.level = 1, give.attr = F, no.list = T)
```

> A list of `r length(data_nes$data_2018)` `data.frames`, one for each seal

For convenience, we aggregate all `r length(data_nes$data_2018)` individuals into one dataset.

```{r, eval=FALSE}
# combine all individuals
data_2018 = rbindlist(data_nes$year_2018, use.name = TRUE, idcol = TRUE)

# display
DT::datatable(data_2018[sample.int(.N,100),],options=list(scrollX=T))
```
```{r, echo=FALSE, results='asis'}
# combine all individuals
data_2018 = rbindlist(data_nes$year_2018, use.name = TRUE, idcol = TRUE)

# title
cat("<table style='width: 50%'>",paste0("<caption>", "(#tab:myDThtmltools)", "Sample of 100 random rows from `data_2018`", "</caption>"),"</table>", sep ="\n")

# display

DT::datatable(data_2018[sample.int(.N,100),],options=list(scrollX=T))
```
 
## Summary

```{r}
# raw_data
data_2018[, .(
  nb_days_recorded = uniqueN(as.Date(date)),
  nb_dives = .N,
  maxdepth_mean = mean(maxdepth),
  dduration_mean = mean(dduration),
  botttime_mean = mean(botttime),
  pdi_mean = mean(pdi, na.rm=T)
), by =.id] %>%
  sable(caption="Summary diving information relative to each 2018 individual", 
        digits=2)
```
> Very nice dataset :)

## Some explanatory plots

```{r, fig.cap="Check for missing values"}
dataPlot = melt(as.data.table(is.na(data_2018)))

ggplot(dataPlot, aes(x = Var2, y = Var1, fill = value))+
  geom_tile()+
  labs(x = "Attributes", y = "Rows")+
  scale_fill_manual(values = c("white", "black"), 
                    labels = c("Real", "Missing")) +
  theme(legend.position = "top", 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.key = element_rect(colour = "black"))

```


```{r, fig.cap="Evolution of all parameters accross time", cache=TRUE, fig.width=9}
# plot raw data
ggplot(data = melt(data_2018[, -c("divenumber",
                                  "year",
                                  "month",
                                  "day",
                                  "hour",
                                  "min",
                                  "sec",
                                  "juldate",
                                  "divetype")], id.vars = c(".id", "date")),
       aes(x = as.Date(date), y = value, col = .id)) +
  geom_point(show.legend = FALSE, alpha = 1 / 10) +
  facet_grid(variable ~ .id, scales = "free") +
  scale_x_date(date_labels = "%m/%Y") +
  theme_jjo() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

